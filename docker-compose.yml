# SPDX-License-Identifier: BSD-3-Clause
# Copyright (c) 2026 Aleksandr Ptakhin

services:
  # Apache Cassandra - Open source distributed NoSQL database
  cassandra:
    image: cassandra:5.0
    container_name: lalasearch-cassandra
    ports:
      - "9042:9042"  # CQL native transport
    volumes:
      - cassandra-data:/var/lib/cassandra
    environment:
      - CASSANDRA_CLUSTER_NAME=lalasearch
      - CASSANDRA_DC=datacenter1
      - CASSANDRA_ENDPOINT_SNITCH=SimpleSnitch
      - CASSANDRA_BROADCAST_RPC_ADDRESS=cassandra
      - MAX_HEAP_SIZE=512M
      - HEAP_NEWSIZE=100M
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'SELECT now() FROM system.local'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - lalasearch-network

  # Meilisearch - Full-text search engine for indexed documents
  meilisearch:
    image: getmeili/meilisearch:v1.11.3
    container_name: lalasearch-meilisearch
    ports:
      - "7700:7700"  # HTTP API and web interface
    volumes:
      - meilisearch-data:/meili_data
    environment:
      - MEILI_NO_ANALYTICS=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - lalasearch-network

  # LalaSearch Agent - Web crawler and search agent
  lala-agent:
    build:
      context: ./lala-agent
      dockerfile: Dockerfile
    container_name: lalasearch-agent
    ports:
      - "3000:3000"  # HTTP API
    volumes:
      # Mount source code for hot-reload development
      - ./lala-agent/src:/app/src:ro
      - ./lala-agent/tests:/app/tests:ro
      - ./lala-agent/Cargo.toml:/app/Cargo.toml:ro
      - ./lala-agent/Cargo.lock:/app/Cargo.lock:ro
    env_file:
      - .env
    environment:
      # Override specific values for Docker environment
      - CASSANDRA_HOSTS=cassandra:9042
      - MEILISEARCH_HOST=meilisearch:7700
    depends_on:
      cassandra:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/version"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - lalasearch-network
    # For development, you can override to run in debug mode:
    # command: cargo run

  # Cassandra initialization service (runs once to create schema)
  cassandra-init:
    image: cassandra:5.0
    container_name: lalasearch-cassandra-init
    depends_on:
      cassandra:
        condition: service_healthy
    volumes:
      - ./docker/cassandra/schema.cql:/schema.cql:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo 'Waiting for Cassandra to be ready...'
        sleep 10
        echo 'Initializing Cassandra schema...'
        cqlsh cassandra -f /schema.cql
        echo 'Schema initialized successfully!'
    networks:
      - lalasearch-network
    restart: "no"

  # LalaSearch Web Frontend - Retro 1990s-style UI
  lala-web:
    build:
      context: ./lala-web
      dockerfile: Dockerfile
    container_name: lalasearch-web
    ports:
      - "8080:80"  # Frontend on port 8080
    depends_on:
      lala-agent:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - lalasearch-network

volumes:
  cassandra-data:
    driver: local
  meilisearch-data:
    driver: local

networks:
  lalasearch-network:
    driver: bridge
