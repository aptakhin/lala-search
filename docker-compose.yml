# SPDX-License-Identifier: BSD-3-Clause
# Copyright (c) 2026 Aleksandr Ptakhin

services:
  # Apache Cassandra - Open source distributed NoSQL database
  cassandra:
    image: cassandra:5.0
    container_name: lalasearch-cassandra
    ports:
      - "9042:9042"  # CQL native transport
    volumes:
      - cassandra-data:/var/lib/cassandra
    environment:
      - CASSANDRA_CLUSTER_NAME=lalasearch
      - CASSANDRA_DC=datacenter1
      - CASSANDRA_ENDPOINT_SNITCH=SimpleSnitch
      - CASSANDRA_BROADCAST_RPC_ADDRESS=cassandra
      - MAX_HEAP_SIZE=512M
      - HEAP_NEWSIZE=100M
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'SELECT now() FROM system.local'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - lalasearch-network

  # Meilisearch - Full-text search engine for indexed documents
  meilisearch:
    image: getmeili/meilisearch:v1.31.0
    container_name: lalasearch-meilisearch
    ports:
      - "7700:7700"  # HTTP API and web interface
    volumes:
      - meilisearch-data:/meili_data
    environment:
      - MEILI_NO_ANALYTICS=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - lalasearch-network

  # LalaSearch Agent - Web crawler and search agent
  lala-agent:
    build:
      context: ./lala-agent
      dockerfile: Dockerfile
    container_name: lalasearch-agent
    ports:
      - "3000:3000"  # HTTP API
    volumes:
      # Mount source code for hot-reload development
      - ./lala-agent/src:/app/src:ro
      - ./lala-agent/tests:/app/tests:ro
      - ./lala-agent/Cargo.toml:/app/Cargo.toml:ro
      - ./lala-agent/Cargo.lock:/app/Cargo.lock:ro
    env_file:
      - .env
    environment:
      # Override specific values for Docker environment
      - CASSANDRA_HOSTS=cassandra:9042
      - MEILISEARCH_HOST=meilisearch:7700
      - S3_ENDPOINT=http://minio:9000
    depends_on:
      cassandra-init:
        condition: service_completed_successfully
      meilisearch:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/version"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - lalasearch-network
    # For development, you can override to run in debug mode:
    # command: cargo run

  # Cassandra initialization service (runs once to create schema)
  cassandra-init:
    image: cassandra:5.0
    container_name: lalasearch-cassandra-init
    depends_on:
      cassandra:
        condition: service_healthy
    volumes:
      - ./docker/cassandra/schema.cql:/schema.cql.template:ro
      - ./docker/cassandra/schema_system.cql:/schema_system.cql.template:ro
    env_file:
      - .env
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo 'Waiting for Cassandra to be ready...'
        sleep 10
        echo 'Initializing system keyspace: '$$CASSANDRA_SYSTEM_KEYSPACE
        sed "s/\$${SYSTEM_KEYSPACE_NAME}/$$CASSANDRA_SYSTEM_KEYSPACE/g" /schema_system.cql.template > /schema_system.cql
        cqlsh cassandra -f /schema_system.cql
        echo 'Initializing tenant keyspace: '$$CASSANDRA_KEYSPACE
        sed "s/\$${KEYSPACE_NAME}/$$CASSANDRA_KEYSPACE/g" /schema.cql.template > /schema.cql
        cqlsh cassandra -f /schema.cql
        echo 'Schema initialized successfully!'
    networks:
      - lalasearch-network
    restart: "no"

  # LalaSearch Web Frontend - Retro 1990s-style UI
  lala-web:
    build:
      context: ./lala-web
      dockerfile: Dockerfile
    container_name: lalasearch-web
    ports:
      - "8080:80"  # Frontend on port 8080
    volumes:
      # Mount index.html for live updates
      - ./lala-web/index.html:/usr/share/nginx/html/index.html:ro
    depends_on:
      lala-agent:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - lalasearch-network

  # MinIO - S3-compatible object storage for crawled HTML content
  minio:
    image: minio/minio:latest
    container_name: lalasearch-minio
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Web Console
    volumes:
      - minio-data:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - lalasearch-network

  # MinIO initialization service (runs once to create bucket)
  minio-init:
    image: minio/mc:latest
    container_name: lalasearch-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo 'Configuring MinIO client...'
        mc alias set minio http://minio:9000 minioadmin minioadmin
        echo 'Creating bucket lalasearch-content...'
        mc mb --ignore-existing minio/lalasearch-content
        echo 'Bucket created successfully!'
    networks:
      - lalasearch-network
    restart: "no"

volumes:
  cassandra-data:
    driver: local
  meilisearch-data:
    driver: local
  minio-data:
    driver: local

networks:
  lalasearch-network:
    driver: bridge
