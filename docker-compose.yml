# SPDX-License-Identifier: BSD-3-Clause
# Copyright (c) 2026 Aleksandr Ptakhin

services:
  # Apache Cassandra - Open source distributed NoSQL database
  cassandra:
    image: cassandra:5.0
    container_name: lalasearch-cassandra
    ports:
      - "9042:9042"  # CQL native transport
    volumes:
      - cassandra-data:/var/lib/cassandra
    environment:
      - CASSANDRA_CLUSTER_NAME=lalasearch
      - CASSANDRA_DC=datacenter1
      - CASSANDRA_ENDPOINT_SNITCH=SimpleSnitch
      - CASSANDRA_BROADCAST_RPC_ADDRESS=cassandra
      - MAX_HEAP_SIZE=512M
      - HEAP_NEWSIZE=100M
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'SELECT now() FROM system.local'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - lalasearch-network

  # Meilisearch - Full-text search engine for indexed documents
  meilisearch:
    image: getmeili/meilisearch:v1.31.0
    container_name: lalasearch-meilisearch
    ports:
      - "7700:7700"  # HTTP API and web interface
    volumes:
      - meilisearch-data:/meili_data
    environment:
      - MEILI_NO_ANALYTICS=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - lalasearch-network

  # LalaSearch Agent - Web crawler and search agent
  lala-agent:
    build:
      context: ./lala-agent
      dockerfile: Dockerfile
      args:
        LALA_PATCH_VERSION: ${LALA_PATCH_VERSION:-}
    container_name: lalasearch-agent
    ports:
      - "3000:3000"  # HTTP API
    volumes:
      # Mount source code for hot-reload development
      - ./lala-agent/src:/app/src:ro
      - ./lala-agent/tests:/app/tests:ro
      - ./lala-agent/Cargo.toml:/app/Cargo.toml:ro
      - ./lala-agent/Cargo.lock:/app/Cargo.lock:ro
    env_file:
      - .env
    environment:
      # Override specific values for Docker environment
      - CASSANDRA_HOSTS=cassandra:9042
      - MEILISEARCH_HOST=meilisearch:7700
      - S3_ENDPOINT=http://seaweedfs:8333
    depends_on:
      cassandra-init:
        condition: service_completed_successfully
      meilisearch:
        condition: service_healthy
      seaweedfs-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/version"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - lalasearch-network
    # For development, you can override to run in debug mode:
    # command: cargo run

  # Cassandra initialization service (runs once to create schema)
  cassandra-init:
    image: cassandra:5.0
    container_name: lalasearch-cassandra-init
    depends_on:
      cassandra:
        condition: service_healthy
    volumes:
      - ./docker/cassandra/schema.cql:/schema.cql.template:ro
      - ./docker/cassandra/schema_system.cql:/schema_system.cql.template:ro
    env_file:
      - .env
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo 'Waiting for Cassandra to be ready...'
        sleep 10
        echo 'Initializing system keyspace: '$$CASSANDRA_SYSTEM_KEYSPACE
        sed "s/\$${SYSTEM_KEYSPACE_NAME}/$$CASSANDRA_SYSTEM_KEYSPACE/g" /schema_system.cql.template > /schema_system.cql
        cqlsh cassandra -f /schema_system.cql
        echo 'Initializing tenant keyspace: '$$CASSANDRA_KEYSPACE
        sed "s/\$${KEYSPACE_NAME}/$$CASSANDRA_KEYSPACE/g" /schema.cql.template > /schema.cql
        cqlsh cassandra -f /schema.cql
        echo 'Schema initialized successfully!'
    networks:
      - lalasearch-network
    restart: "no"

  # LalaSearch Web Frontend - Retro 1990s-style UI
  lala-web:
    build:
      context: ./lala-web
      dockerfile: Dockerfile
    container_name: lalasearch-web
    ports:
      - "8081:80"  # Frontend on port 8081
    volumes:
      # Mount index.html for live updates
      - ./lala-web/index.html:/usr/share/nginx/html/index.html:ro
    depends_on:
      lala-agent:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - lalasearch-network

  # SeaweedFS - S3-compatible object storage for crawled HTML content
  seaweedfs:
    image: chrislusf/seaweedfs:latest
    container_name: lalasearch-seaweedfs
    ports:
      - "8333:8333"   # S3 API
      - "9333:9333"   # Master server
      - "8080:8080"   # Volume server (filer)
    volumes:
      - seaweedfs-data:/data
      - ./docker/seaweedfs/s3.json:/etc/seaweedfs/s3.json:ro
    environment:
      - WEED_MASTER_VOLUME_SIZE_LIMIT_MB=1024
    command: 'server -s3 -s3.port=8333 -s3.config=/etc/seaweedfs/s3.json -dir=/data -volume.max=0'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9333/cluster/status || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - lalasearch-network

  # SeaweedFS S3 credential initialization (runs once after SeaweedFS starts)
  # SeaweedFS doesn't reliably load credentials from the static -s3.config file
  # into its filer-based IAM store, so we apply them via weed shell
  seaweedfs-init:
    image: chrislusf/seaweedfs:latest
    container_name: lalasearch-seaweedfs-init
    depends_on:
      seaweedfs:
        condition: service_healthy
    env_file:
      - .env
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo 'Configuring SeaweedFS S3 credentials...'
        echo "s3.configure -access_key=$$S3_ACCESS_KEY -secret_key=$$S3_SECRET_KEY -user=admin -actions=Admin,Read,Write,List,Tagging -apply" | weed shell -master=seaweedfs:9333
        echo 'SeaweedFS S3 credentials configured successfully!'
    networks:
      - lalasearch-network
    restart: "no"

  # Postfix - Local SMTP server for sending emails directly
  # WARNING: Emails will likely go to spam due to missing SPF/DKIM/DMARC
  postfix:
    image: boky/postfix:latest
    container_name: lalasearch-postfix
    ports:
      - "25:25"      # SMTP (unencrypted, local only)
      - "587:587"    # Submission (for local clients)
    environment:
      # Allow sending from any address (for development)
      - ALLOWED_SENDER_DOMAINS=localhost lalasearch.local
      # Disable authentication (local development only!)
      - RELAYHOST=
      # Message size limit (10MB)
      - MESSAGE_SIZE_LIMIT=10485760
    healthcheck:
      test: ["CMD", "postfix", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - lalasearch-network


volumes:
  cassandra-data:
    driver: local
  meilisearch-data:
    driver: local
  seaweedfs-data:
    driver: local

networks:
  lalasearch-network:
    driver: bridge
